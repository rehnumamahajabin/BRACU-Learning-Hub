{% extends 'dashboard/base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4>{{ material.title }}</h4>
          <div>
            {% if user == material.uploaded_by %}
            <a href="{% url 'material_edit' material.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-pencil"></i> Edit
            </a>
            {% endif %}
            <a href="{{ material.file.url }}" class="btn btn-sm btn-success" download>
              <i class="bi bi-download"></i> Download
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <p><strong>Subject:</strong> {{ material.subject.name }} ({{ material.subject.code }})</p>
            <p><strong>Type:</strong> <span class="badge bg-info">{{ material.get_material_type_display }}</span></p>
            <p><strong>Uploaded by:</strong> 
              <a href="#" class="text-decoration-none">{{ material.uploaded_by.username }}</a>
              {% if material.uploaded_by == user %}
              <span class="badge bg-secondary">You</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <p><strong>Upload Date:</strong> {{ material.upload_date|date:"F d, Y" }}</p>
            <p><strong>Downloads:</strong> {{ material.downloads }}</p>
            <p><strong>Views:</strong> {{ material.views }}</p>
            <p><strong>Status:</strong> 
              {% if material.is_approved %}
              <span class="badge bg-success">Approved</span>
              {% else %}
              <span class="badge bg-warning">Pending Approval</span>
              {% endif %}
            </p>
          </div>
        </div>

        <div class="mb-4">
          <h5>Description</h5>
          <p>{{ material.description }}</p>
        </div>

        {% if material.tags %}
        <div class="mb-4">
          <h5>Tags</h5>
          {% for tag in material.tags.split %}
          <span class="badge bg-light text-dark me-1">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6>Rating & Reviews</h6>
              </div>
              <div class="card-body text-center">
                <h1 class="display-4">{{ avg_rating|default:"0.0" }}</h1>
                <div class="text-warning mb-2">
                  {% for i in "12345" %}
                  {% if forloop.counter <= avg_rating|floatformat:"0" %}
                  <i class="bi bi-star-fill"></i>
                  {% else %}
                  <i class="bi bi-star"></i>
                  {% endif %}
                  {% endfor %}
                </div>
                <p class="text-muted">Based on {{ material.ratings.count }} ratings</p>
                
                {% if user.is_authenticated and not user_rating %}
                <form method="POST" action="{% url 'rate_material' material.pk %}" class="mt-3">
                  {% csrf_token %}
                  <div class="btn-group" role="group">
                    <input type="hidden" name="score" id="rating-value">
                    {% for i in "12345" %}
                    <button type="button" class="btn btn-outline-warning rating-btn" data-value="{{ forloop.counter }}">
                      {{ forloop.counter }} <i class="bi bi-star"></i>
                    </button>
                    {% endfor %}
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm mt-2 d-none" id="submit-rating">
                    Submit Rating
                  </button>
                </form>
                {% elif user.is_authenticated and user_rating %}
                <p class="text-success">You rated: {{ user_rating.score }} <i class="bi bi-star-fill text-warning"></i></p>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6>Actions</h6>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <form method="POST" action="{% url 'save_material' material.pk %}">
                    {% csrf_token %}
                    {% if is_saved %}
                    <button type="submit" class="btn btn-warning">
                      <i class="bi bi-bookmark-check"></i> Remove from Saved
                    </button>
                    {% else %}
                    <button type="submit" class="btn btn-outline-primary">
                      <i class="bi bi-bookmark"></i> Save Material
                    </button>
                    {% endif %}
                  </form>
                  
                  <a href="{{ material.file.url }}" class="btn btn-success" target="_blank">
                    <i class="bi bi-eye"></i> Preview File
                  </a>
                  
                  <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shareModal">
                    <i class="bi bi-share"></i> Share
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h5>Comments ({{ comments.count }})</h5>
          </div>
          <div class="card-body">
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'add_comment' material.pk %}">
              {% csrf_token %}
              <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" placeholder="Add a comment..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Post Comment
              </button>
            </form>
            <hr>
            {% endif %}

            {% if comments %}
            <div class="comments-section">
              {% for comment in comments %}
              <div class="card mb-3 {% if comment.is_reported %}border-danger{% endif %}">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>{{ comment.user.username }}</strong>
                      <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-outline-success" onclick="voteComment('{{ comment.pk }}', 'upvote')">
                        <i class="bi bi-hand-thumbs-up"></i> {{ comment.upvotes }}
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="voteComment('{{ comment.pk }}', 'downvote')">
                        <i class="bi bi-hand-thumbs-down"></i> {{ comment.downvotes }}
                      </button>
                    </div>
                  </div>
                  <p class="mt-2 mb-0">{{ comment.content }}</p>
                  {% if comment.is_reported %}
                  <span class="badge bg-danger mt-2">Reported</span>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted text-center py-4">No comments yet. Be the first to comment!</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5>Material Info</h5>
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between">
            <span>File Type</span>
            <strong>{{ material.file.name|slice:"-4:"|upper }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>File Size</span>
            <strong>{{ material.file.size|filesizeformat }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Ratings</span>
            <strong>{{ material.ratings.count }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Comments</span>
            <strong>{{ comments.count }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Saves</span>
            <strong>{{ material.savedmaterial_set.count }}</strong>
          </li>
        </ul>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5>Similar Materials</h5>
      </div>
      <div class="card-body">
        {% with similar=material.subject.material_set.all|slice:":5" %}
        {% if similar %}
        <div class="list-group list-group-flush">
          {% for sim in similar %}
          {% if sim.pk != material.pk %}
          <a href="{% url 'material_detail' sim.pk %}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ sim.title|truncatechars:30 }}</h6>
              <small class="text-muted">{{ sim.upload_date|timesince }} ago</small>
            </div>
            <small class="text-muted">{{ sim.get_material_type_display }}</small>
          </a>
          {% endif %}
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No similar materials found.</p>
        {% endif %}
        {% endwith %}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h5>Uploader Profile</h5>
      </div>
      <div class="card-body text-center">
        <img src="{{ material.uploaded_by.profile.image.url }}" class="rounded-circle mb-2" width="80" height="80" style="object-fit: cover;">
        <h6>{{ material.uploaded_by.username }}</h6>
        <p class="text-muted small">{{ material.uploaded_by.profile.department.name|default:"No department" }}</p>
        
        <div class="row text-center mt-3">
          <div class="col-4">
            <h6>{{ material.uploaded_by.material_set.count }}</h6>
            <small class="text-muted">Uploads</small>
          </div>
          <div class="col-4">
            <h6>{{ material.uploaded_by.profile.reputation }}</h6>
            <small class="text-muted">Reputation</small>
          </div>
          <div class="col-4">
            <h6>{{ material.uploaded_by.post_set.count }}</h6>
            <small class="text-muted">Posts</small>
          </div>
        </div>
        
        <button class="btn btn-outline-primary btn-sm mt-3">
          <i class="bi bi-person-plus"></i> View Profile
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share Material</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="share-url" value="{{ request.build_absolute_uri }}" readonly>
          <button class="btn btn-primary" onclick="copyShareUrl()">
            <i class="bi bi-clipboard"></i> Copy
          </button>
        </div>
        <div class="text-center">
          <p class="text-muted">Share this material with others</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Rating system
    const ratingButtons = document.querySelectorAll('.rating-btn');
    const ratingValue = document.querySelector('#rating-value');
    const submitButton = document.querySelector('#submit-rating');
    
    ratingButtons.forEach(button => {
      button.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        ratingValue.value = value;
        
        // Update button states
        ratingButtons.forEach(btn => {
          btn.classList.remove('active', 'btn-warning');
          btn.classList.add('btn-outline-warning');
        });
        
        for (let i = 0; i < value; i++) {
          ratingButtons[i].classList.remove('btn-outline-warning');
          ratingButtons[i].classList.add('btn-warning', 'active');
        }
        
        submitButton.classList.remove('d-none');
      });
    });
    
    // Copy share URL
    window.copyShareUrl = function() {
      const urlInput = document.querySelector('#share-url');
      urlInput.select();
      document.execCommand('copy');
      
      const copyBtn = document.querySelector('[onclick="copyShareUrl()"]');
      const originalHtml = copyBtn.innerHTML;
      copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
      copyBtn.classList.remove('btn-primary');
      copyBtn.classList.add('btn-success');
      
      setTimeout(() => {
        copyBtn.innerHTML = originalHtml;
        copyBtn.classList.remove('btn-success');
        copyBtn.classList.add('btn-primary');
      }, 2000);
    };
  });
  
  function voteComment(commentId, voteType) {
    // This would require AJAX in a real implementation
    alert(`Would ${voteType} comment ${commentId} in a real implementation`);
  }
</script>
{% endblock %}