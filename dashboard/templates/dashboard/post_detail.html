{% extends 'dashboard/base.html' %}

{% block content %}
<div class="row">
  <div class="col-lg-8">
    <!-- Post Content -->
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="badge bg-secondary">{{ post.get_post_type_display }}</span>
            {% if post.is_pinned %}
            <span class="badge bg-warning ms-1">
              <i class="bi bi-pin-angle"></i> Pinned
            </span>
            {% endif %}
            {% if post.is_reported %}
            <span class="badge bg-danger ms-1">Reported</span>
            {% endif %}
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-bookmark"></i> Save</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-share"></i> Share</a></li>
              {% if user == post.user %}
              <li><a class="dropdown-item" href="#"><i class="bi bi-pencil"></i> Edit</a></li>
              <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash"></i> Delete</a></li>
              {% else %}
              <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-flag"></i> Report</a></li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="d-flex align-items-start mb-4">
          <img src="{{ post.user.profile.image.url }}" class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">
          <div>
            <h5 class="mb-1">{{ post.title }}</h5>
            <p class="text-muted mb-0">
              <a href="#" class="text-decoration-none">{{ post.user.username }}</a>
              • {{ post.created_at|timesince }} ago
              {% if post.updated_at != post.created_at %}
              • Edited {{ post.updated_at|timesince }} ago
              {% endif %}
              {% if post.subject %}
              • <i class="bi bi-journal-text"></i> {{ post.subject.name }}
              {% endif %}
            </p>
          </div>
        </div>

        <div class="post-content mb-4">
          {{ post.content|linebreaks }}
        </div>

        {% if post.tags %}
        <div class="mb-4">
          {% for tag in post.tags.split %}
          <span class="badge bg-light text-dark me-1">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center border-top border-bottom py-3">
          <div>
            <button class="btn btn-outline-success btn-sm">
              <i class="bi bi-hand-thumbs-up"></i> Like ({{ post.upvotes }})
            </button>
            <button class="btn btn-outline-danger btn-sm ms-2">
              <i class="bi bi-hand-thumbs-down"></i> Dislike ({{ post.downvotes }})
            </button>
          </div>
          <div>
            <span class="text-muted">
              <i class="bi bi-eye"></i> Views: {{ post.views|default:"0" }}
            </span>
            <span class="text-muted ms-3">
              <i class="bi bi-chat"></i> Comments: {{ comments.count }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="card mt-4">
      <div class="card-header">
        <h5>Comments ({{ comments.count }})</h5>
      </div>
      <div class="card-body">
        {% if user.is_authenticated %}
        <div class="mb-4">
          <form method="POST" action="{% url 'add_post_comment' post.pk %}">
            {% csrf_token %}
            <div class="d-flex align-items-start">
              <img src="{{ user.profile.image.url }}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
              <div class="flex-grow-1">
                <textarea name="content" class="form-control" rows="3" placeholder="Write a comment..." required></textarea>
                <div class="mt-2">
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-send"></i> Post Comment
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
        {% else %}
        <div class="alert alert-info mb-4">
          <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">Login</a> to post a comment.
        </div>
        {% endif %}

        <div class="comments-section">
          {% if comments %}
          {% for comment in comments %}
          <div class="card mb-3 {% if comment.is_reported %}border-danger{% endif %}">
            <div class="card-body">
              <div class="d-flex">
                <img src="{{ comment.user.profile.image.url }}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-0">{{ comment.user.username }}</h6>
                      <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                    </div>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                      </button>
                      <ul class="dropdown-menu">
                        {% if user == comment.user %}
                        <li><a class="dropdown-item" href="#"><i class="bi bi-pencil"></i> Edit</a></li>
                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-trash"></i> Delete</a></li>
                        {% else %}
                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-flag"></i> Report</a></li>
                        {% endif %}
                      </ul>
                    </div>
                  </div>
                  <p class="mt-2 mb-2">{{ comment.content }}</p>
                  <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-success">
                      <i class="bi bi-hand-thumbs-up"></i> {{ comment.upvotes }}
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2">
                      <i class="bi bi-hand-thumbs-down"></i> {{ comment.downvotes }}
                    </button>
                    <button class="btn btn-sm btn-outline-primary ms-2">
                      <i class="bi bi-reply"></i> Reply
                    </button>
                    {% if comment.is_reported %}
                    <span class="badge bg-danger ms-2">Reported</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-chat-text" style="font-size: 2rem; color: #ccc;"></i>
            <p class="mt-2 text-muted">No comments yet. Be the first to comment!</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- Post Author -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Post Author</h5>
      </div>
      <div class="card-body text-center">
        <img src="{{ post.user.profile.image.url }}" class="rounded-circle mb-3" width="100" height="100" style="object-fit: cover;">
        <h5>{{ post.user.username }}</h5>
        <p class="text-muted">{{ post.user.profile.department.name|default:"No department" }}</p>
        
        <div class="row text-center mt-3">
          <div class="col-4">
            <h6>{{ post.user.material_set.count }}</h6>
            <small class="text-muted">Materials</small>
          </div>
          <div class="col-4">
            <h6>{{ post.user.post_set.count }}</h6>
            <small class="text-muted">Posts</small>
          </div>
          <div class="col-4">
            <h6>{{ post.user.profile.reputation }}</h6>
            <small class="text-muted">Reputation</small>
          </div>
        </div>
        
        <button class="btn btn-outline-primary btn-sm mt-3">
          <i class="bi bi-person-plus"></i> View Profile
        </button>
        <button class="btn btn-outline-success btn-sm mt-3">
          <i class="bi bi-chat"></i> Message
        </button>
      </div>
    </div>

    <!-- Related Posts -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Related Posts</h5>
      </div>
      <div class="card-body">
        {% with related=post.subject.post_set.all|slice:":5" %}
        {% if related %}
        <div class="list-group list-group-flush">
          {% for rel in related %}
          {% if rel.pk != post.pk %}
          <a href="{% url 'post_detail' rel.pk %}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ rel.title|truncatechars:30 }}</h6>
              <small class="text-muted">{{ rel.created_at|timesince }} ago</small>
            </div>
            <small class="text-muted">{{ rel.get_post_type_display }}</small>
          </a>
          {% endif %}
          {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No related posts found.</p>
        {% endif %}
        {% endwith %}
        <a href="{% url 'post_list' %}" class="btn btn-outline-primary btn-sm mt-3 w-100">
          <i class="bi bi-list"></i> View All Posts
        </a>
      </div>
    </div>

    <!-- Post Statistics -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Post Statistics</h5>
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between">
            <span>Created</span>
            <strong>{{ post.created_at|date:"M d, Y" }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Last Updated</span>
            <strong>{{ post.updated_at|timesince }} ago</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Comments</span>
            <strong>{{ comments.count }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Likes</span>
            <strong>{{ post.upvotes }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Dislikes</span>
            <strong>{{ post.downvotes }}</strong>
          </li>
        </ul>
      </div>
    </div>

    <!-- Share Options -->
    <div class="card">
      <div class="card-header">
        <h5>Share This Post</h5>
      </div>
      <div class="card-body">
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="post-url" value="{{ request.build_absolute_uri }}" readonly>
          <button class="btn btn-primary" onclick="copyPostUrl()">
            <i class="bi bi-clipboard"></i> Copy
          </button>
        </div>
        <div class="d-flex justify-content-center gap-2">
          <button class="btn btn-outline-primary">
            <i class="bi bi-facebook"></i>
          </button>
          <button class="btn btn-outline-info">
            <i class="bi bi-twitter"></i>
          </button>
          <button class="btn btn-outline-success">
            <i class="bi bi-whatsapp"></i>
          </button>
          <button class="btn btn-outline-danger">
            <i class="bi bi-envelope"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Like/Dislike functionality
    const likeBtn = document.querySelector('.btn-outline-success');
    const dislikeBtn = document.querySelector('.btn-outline-danger');
    
    if (likeBtn) {
      likeBtn.addEventListener('click', function() {
        const countText = this.textContent.match(/\((\d+)\)/);
        if (countText) {
          const currentCount = parseInt(countText[1]);
          const isActive = this.classList.contains('btn-success');
          
          if (isActive) {
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-success');
            this.innerHTML = `<i class="bi bi-hand-thumbs-up"></i> Like (${currentCount - 1})`;
          } else {
            this.classList.remove('btn-outline-success');
            this.classList.add('btn-success');
            this.innerHTML = `<i class="bi bi-hand-thumbs-up"></i> Like (${currentCount + 1})`;
          }
        }
      });
    }
    
    if (dislikeBtn) {
      dislikeBtn.addEventListener('click', function() {
        const countText = this.textContent.match(/\((\d+)\)/);
        if (countText) {
          const currentCount = parseInt(countText[1]);
          const isActive = this.classList.contains('btn-danger');
          
          if (isActive) {
            this.classList.remove('btn-danger');
            this.classList.add('btn-outline-danger');
            this.innerHTML = `<i class="bi bi-hand-thumbs-down"></i> Dislike (${currentCount - 1})`;
          } else {
            this.classList.remove('btn-outline-danger');
            this.classList.add('btn-danger');
            this.innerHTML = `<i class="bi bi-hand-thumbs-down"></i> Dislike (${currentCount + 1})`;
          }
        }
      });
    }
    
    // Comment like/dislike
    const commentLikeBtns = document.querySelectorAll('.comments-section .btn-outline-success');
    const commentDislikeBtns = document.querySelectorAll('.comments-section .btn-outline-danger');
    
    commentLikeBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const countText = this.textContent.match(/\d+/);
        if (countText) {
          const currentCount = parseInt(countText[0]);
          const isActive = this.classList.contains('btn-success');
          
          if (isActive) {
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-success');
            this.innerHTML = `<i class="bi bi-hand-thumbs-up"></i> ${currentCount - 1}`;
          } else {
            this.classList.remove('btn-outline-success');
            this.classList.add('btn-success');
            this.innerHTML = `<i class="bi bi-hand-thumbs-up"></i> ${currentCount + 1}`;
          }
        }
      });
    });
    
    commentDislikeBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const countText = this.textContent.match(/\d+/);
        if (countText) {
          const currentCount = parseInt(countText[0]);
          const isActive = this.classList.contains('btn-danger');
          
          if (isActive) {
            this.classList.remove('btn-danger');
            this.classList.add('btn-outline-danger');
            this.innerHTML = `<i class="bi bi-hand-thumbs-down"></i> ${currentCount - 1}`;
          } else {
            this.classList.remove('btn-outline-danger');
            this.classList.add('btn-danger');
            this.innerHTML = `<i class="bi bi-hand-thumbs-down"></i> ${currentCount + 1}`;
          }
        }
      });
    });
    
    // Copy URL functionality
    window.copyPostUrl = function() {
      const urlInput = document.querySelector('#post-url');
      urlInput.select();
      document.execCommand('copy');
      
      const copyBtn = document.querySelector('[onclick="copyPostUrl()"]');
      const originalHtml = copyBtn.innerHTML;
      copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
      copyBtn.classList.remove('btn-primary');
      copyBtn.classList.add('btn-success');
      
      setTimeout(() => {
        copyBtn.innerHTML = originalHtml;
        copyBtn.classList.remove('btn-success');
        copyBtn.classList.add('btn-primary');
      }, 2000);
    };
    
    // Reply button functionality
    const replyBtns = document.querySelectorAll('.comments-section .btn-outline-primary');
    replyBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const commentCard = this.closest('.card-body');
        const user = commentCard.querySelector('h6').textContent;
        
        const textarea = document.querySelector('textarea[name="content"]');
        if (textarea) {
          textarea.value = `@${user} `;
          textarea.focus();
        }
      });
    });
  });
</script>
{% endblock %}