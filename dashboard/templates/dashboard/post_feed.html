{% extends 'dashboard/base.html' %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-8">
    <h2>Discussions</h2>
    <p class="text-muted">Join conversations, ask questions, and share knowledge</p>
  </div>
  <div class="col-md-4 text-end">
    {% if user.is_authenticated %}
    <a href="{% url 'post_create' %}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> Create Post
    </a>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" action="{% url 'post_list' %}" class="row g-2">
          <div class="col-md-5">
            <input type="text" name="q" class="form-control" placeholder="Search discussions..." value="{{ request.GET.q }}">
          </div>
          <div class="col-md-4">
            <select name="type" class="form-select">
              <option value="">All Types</option>
              <option value="question" {% if request.GET.type == 'question' %}selected{% endif %}>Questions</option>
              <option value="discussion" {% if request.GET.type == 'discussion' %}selected{% endif %}>Discussions</option>
              <option value="personal" {% if request.GET.type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="announcement" {% if request.GET.type == 'announcement' %}selected{% endif %}>Announcements</option>
              <option value="resource" {% if request.GET.type == 'resource' %}selected{% endif %}>Resource Sharing</option>
            </select>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-funnel"></i> Filter
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Pinned Posts -->
    {% with pinned_posts=posts|slice:":3" %}
    {% for post in pinned_posts %}
    {% if post.is_pinned %}
    <div class="card border-warning mb-3">
      <div class="card-header bg-warning bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="badge bg-warning">
              <i class="bi bi-pin-angle"></i> Pinned
            </span>
            <span class="badge bg-secondary ms-1">{{ post.get_post_type_display }}</span>
          </div>
          <small class="text-muted">{{ post.created_at|timesince }} ago</small>
        </div>
      </div>
      <div class="card-body">
        <h5 class="card-title">
          <a href="{% url 'post_detail' post.pk %}" class="text-decoration-none">{{ post.title }}</a>
        </h5>
        <p class="card-text">{{ post.content|truncatechars:200 }}</p>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="text-muted">
              <i class="bi bi-person"></i> {{ post.user.username }}
              {% if post.subject %}
              <i class="bi bi-journal-text ms-2"></i> {{ post.subject.name }}
              {% endif %}
            </span>
          </div>
          <div>
            <span class="badge bg-light text-dark">
              <i class="bi bi-chat"></i> {{ post.post_comments.count }}
            </span>
            <span class="badge bg-light text-dark ms-1">
              <i class="bi bi-hand-thumbs-up"></i> {{ post.upvotes }}
            </span>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% endwith %}

    <!-- Regular Posts -->
    {% if posts %}
    {% for post in posts %}
    {% if not post.is_pinned %}
    <div class="card mb-3">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="badge bg-secondary">{{ post.get_post_type_display }}</span>
            {% if post.is_reported %}
            <span class="badge bg-danger ms-1">Reported</span>
            {% endif %}
          </div>
          <small class="text-muted">{{ post.created_at|timesince }} ago</small>
        </div>
      </div>
      <div class="card-body">
        <h5 class="card-title">
          <a href="{% url 'post_detail' post.pk %}" class="text-decoration-none">{{ post.title }}</a>
        </h5>
        <p class="card-text">{{ post.content|truncatechars:300 }}</p>
        
        {% if post.tags %}
        <div class="mb-3">
          {% for tag in post.tags.split %}
          <span class="badge bg-light text-dark small me-1">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}
        
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <a href="#" class="text-decoration-none">
              <img src="{{ post.user.profile.image.url }}" class="rounded-circle" width="30" height="30" style="object-fit: cover;">
              <span class="ms-2">{{ post.user.username }}</span>
            </a>
            {% if post.subject %}
            <span class="text-muted ms-3">
              <i class="bi bi-journal-text"></i> {{ post.subject.name }}
            </span>
            {% endif %}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-success">
              <i class="bi bi-hand-thumbs-up"></i> {{ post.upvotes }}
            </button>
            <a href="{% url 'post_detail' post.pk %}" class="btn btn-sm btn-outline-primary ms-1">
              <i class="bi bi-chat"></i> {{ post.post_comments.count }}
            </a>
            <button class="btn btn-sm btn-outline-secondary ms-1" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-bookmark"></i> Save</a></li>
              <li><a class="dropdown-item" href="#"><i class="bi bi-share"></i> Share</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-flag"></i> Report</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    {% endfor %}
    {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="bi bi-chat-square-text" style="font-size: 3rem; color: #ccc;"></i>
        <h4 class="mt-3">No Discussions Found</h4>
        <p class="text-muted">Try adjusting your filters or start the first discussion!</p>
        {% if user.is_authenticated %}
        <a href="{% url 'post_create' %}" class="btn btn-success mt-2">
          <i class="bi bi-plus-circle"></i> Create First Post
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&q={{ request.GET.q }}&type={{ request.GET.type }}">First</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&type={{ request.GET.type }}">Previous</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <li class="page-item active">
          <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}&type={{ request.GET.type }}">{{ num }}</a>
        </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
        <li class="page-item">
          <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}&type={{ request.GET.type }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&type={{ request.GET.type }}">Next</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ request.GET.q }}&type={{ request.GET.type }}">Last</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>

  <div class="col-md-4">
    <!-- Create Post Card -->
    {% if user.is_authenticated %}
    <div class="card mb-4">
      <div class="card-header">
        <h5>Create New Post</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{% url 'post_create' %}?type=question" class="btn btn-outline-primary">
            <i class="bi bi-question-circle"></i> Ask a Question
          </a>
          <a href="{% url 'post_create' %}?type=discussion" class="btn btn-outline-primary">
            <i class="bi bi-chat-left-text"></i> Start Discussion
          </a>
          <a href="{% url 'post_create' %}?type=resource" class="btn btn-outline-primary">
            <i class="bi bi-share"></i> Share Resource
          </a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Trending Tags -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>Trending Tags</h5>
      </div>
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2">
          <span class="badge bg-primary">CSE470</span>
          <span class="badge bg-primary">Midterm</span>
          <span class="badge bg-primary">Project</span>
          <span class="badge bg-primary">Assignment</span>
          <span class="badge bg-primary">BRACU</span>
          <span class="badge bg-primary">StudyGroup</span>
          <span class="badge bg-primary">Notes</span>
          <span class="badge bg-primary">Help</span>
          <span class="badge bg-primary">University</span>
          <span class="badge bg-primary">Exam</span>
        </div>
      </div>
    </div>

    <!-- Community Guidelines -->
    <div class="card">
      <div class="card-header">
        <h5>Community Guidelines</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled small">
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> Be respectful to others
          </li>
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> Stay on topic
          </li>
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> No spam or self-promotion
          </li>
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> Use appropriate language
          </li>
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> Report inappropriate content
          </li>
          <li class="mb-2">
            <i class="bi bi-check-circle text-success"></i> Help fellow students
          </li>
        </ul>
      </div>
    </div>

    <!-- Statistics -->
    <div class="card mt-4">
      <div class="card-header">
        <h5>Discussion Stats</h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <h4>{{ posts.count }}</h4>
            <small class="text-muted">Total Posts</small>
          </div>
          <div class="col-6">
            <h4>{{ total_comments|default:"0" }}</h4>
            <small class="text-muted">Total Comments</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Post interaction functionality
    const likeButtons = document.querySelectorAll('.btn-outline-success');
    
    likeButtons.forEach(button => {
      button.addEventListener('click', function() {
        const currentCount = parseInt(this.querySelector('i').nextSibling.textContent.trim());
        const isActive = this.classList.contains('btn-success');
        
        if (isActive) {
          this.classList.remove('btn-success');
          this.classList.add('btn-outline-success');
          this.querySelector('i').nextSibling.textContent = ` ${currentCount - 1}`;
        } else {
          this.classList.remove('btn-outline-success');
          this.classList.add('btn-success');
          this.querySelector('i').nextSibling.textContent = ` ${currentCount + 1}`;
        }
      });
    });
  });
</script>
{% endblock %}